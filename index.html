<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SURE!</title>

  <!-- (Valfritt) Om Unity-bygget hostas på annan origin, preconnecta den: -->
  <!-- <link rel="preconnect" href="https://cdn-din-domän.example" crossorigin> -->

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

  <style>
@font-face {
  font-family: "CircularStd";
  src: url("font/CircularStd-Bold.otf") format("opentype");
  font-weight: 700;
  font-style: normal;
  font-display: swap;
}
@font-face {
  font-family: "CircularStd-Book";
  src: url("font/CircularStd-Book.otf") format("opentype");
  font-weight: 400;
  font-style: normal;
  font-display: swap;
}
@font-face {
  font-family: 'BRLNSDB';
  src: url('font/BRLNSDB.TTF') format('truetype');
  font-weight: normal;
  font-style: normal;
}

:root {
  --fade-in: 1600ms;
  --fade-out: 700ms;
  --brand-scale: 1.25;
}

html, body {
  margin: 0;
  height: 100%;
  overflow: hidden;
  background: linear-gradient(to top, #d299c2 0%, #fef9d7 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  text-align: center;

  /* Mobilfinesser */
  overscroll-behavior: none;
  touch-action: manipulation;
}

.stage {
  position: fixed; inset: 0;
  display: grid; place-items: center;
  background: transparent;
  color: #ffffff;
  transition: opacity var(--fade-out) ease;
}
.stage.hide { opacity: 0; pointer-events: none; }

.stack { text-align: center; display: grid; gap: 16px; padding: 24px; }

.title-wrapper { margin-bottom: 20px; width: 100%; max-width: 500px; margin: 0 auto; }

.title {
  font-family: 'BRLNSDB', sans-serif;
  font-size: 180px; color: white; margin-bottom: 10px; font-weight: 700;
  white-space: nowrap; text-overflow: ellipsis; overflow: hidden;
}

.subtext {
  font-family: "CircularStd", sans-serif;
  font-size: 30px; color: white; margin-bottom: 30px;
  word-wrap: break-word; text-align: center; line-height: 1.5; max-width: 100%;
}

.meter {
  display: flex; justify-content: center; align-items: baseline;
  font-size: clamp(56px, 22vw, 240px);
  font-family: 'BRLNSDB', sans-serif;
  line-height: 1;
  padding-right: 1.4ch;
  max-width: 100vw; overflow: hidden; margin: 0 auto;
}
.meter span {
  display: inline-block; min-width: 3ch; text-align: right;
  font-weight: bold; font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1;
}

/* valfritt: finjustering små mobiler */
@media (max-width: 600px) {
  .meter { padding-right: 1.2ch; }
}

.unity-wrap {
  position: fixed; inset: 0; opacity: 0; transition: opacity var(--fade-in) ease; z-index: 1;
}
.unity-wrap.show { opacity: 1; }
.unity-frame { width: 100%; height: 100%; border: 0; display: block; background: transparent; }

#comment-icon {
  position: fixed; top: 20px; right: 20px; font-size: 30px;
  color: rgba(230, 57, 70, 0.75); cursor: pointer; z-index: 9999;
}

.overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background-color: rgba(230, 57, 70, 0.75);
  display: none; z-index: 9998; justify-content: center; align-items: center;
}

/* Kommentarsruta */
.comment-box {
  background: rgba(230, 57, 70, 0.85);
  border-radius: 20px; padding: 30px; width: 90%; max-width: 500px;
  text-align: center; font-family: "CircularStd", sans-serif;
  max-height: 600px; display: flex; flex-direction: column;
  overflow-y: auto; overflow-x: hidden; box-sizing: border-box;
}

.comment-box h2 {
  font-family: "CircularStd", sans-serif; font-size: 32px; color: white;
  margin-bottom: 15px; font-weight: 600;
}

.comment-box textarea {
  font-family: "CircularStd", sans-serif;
  background: rgba(249, 70, 85, 0.75);
  width: 100%; height: 350px; padding: 10px;
  border: none; border-radius: 8px; resize: none; font-size: 14px; color: white;
  margin-bottom: 12px; overflow-y: auto; overflow-x: hidden; box-sizing: border-box;
}
.comment-box textarea::placeholder { color: white; }

/* Skicka-knapp + status */
.actions { display: grid; gap: 8px; }
.comment-box button {
  font-family: "CircularStd", sans-serif; padding: 10px 20px; font-size: 16px;
  background-color: rgba(249, 70, 85, 0.75); color: white; border: none; border-radius: 5px; cursor: pointer;
}
.comment-box button:hover { background-color: #d32f2f; }
.status {
  font-family: "CircularStd-Book", sans-serif; font-size: 12px; color: #fff; opacity: .9; min-height: 18px;
}

/* Informations-text under knappen */
.info-text {
  font-family: "CircularStd-Book", sans-serif;
  font-size: 12px; color: #fff; opacity: 0.85; margin-top: 10px; line-height: 1.4; text-align: center;
}

/* Mobilanpassning */
@media (max-width: 600px) {
  .title-wrapper { padding: 10px; max-width: 90%; }
  .title { font-size: 50px; }
  .subtext { font-size: 18px; }
  .comment-box { max-height: 80%; }
  .comment-box textarea { height: 200px; }
}
  </style>
</head>
<body>

  <!-- Förstasidan -->
  <div class="stage" id="stage">
    <div class="stack">
      <div class="title-wrapper">
        <h1 class="title">SURE!</h1>
        <p class="subtext">Välkommen till att utforska framtidens Polhemsgata.</p>
        <p class="subtext">Ett ögonblick, vi laddar 2050...</p>
      </div>
      <div class="meter"><span id="pct">1</span>%</div>
    </div>
  </div>

  <!-- Unity-inbäddning -->
  <div class="unity-wrap" id="unityWrap" aria-hidden="true">
    <iframe
      id="unityFrame"
      class="unity-frame"
      src=""
      allow="autoplay; fullscreen; xr-spatial-tracking; accelerometer; gyroscope"
      allowfullscreen
    ></iframe>
  </div>

  <!-- Kommentarikon -->
  <i id="comment-icon" class="fa-solid fa-comment"></i>

  <!-- Overlay -->
  <div id="overlay" class="overlay">
    <div class="comment-box">
      <h2>Berätta hur du vill att Polhemsgatan ska upplevas och vad den ska innehålla år 2050!</h2>
      <textarea id="comment-text" placeholder="Skriv din kommentar här..."></textarea>

      <div class="actions">
        <button id="submit-comment">Skicka</button>
        <div id="status" class="status"></div>
      </div>

      <p class="info-text">
        Dina kommentarer skickas till projektgruppen för SURE Kalmar – Framtidens Mötesplats.
        Informationen kommer användas som del av utvärdering av projektet. <br><br>
        SURE Kalmar – Framtidens Mötesplats är ett projekt inom Shift Sweden med finansiering
        av Vinnova, Formas och Energimyndigheten. Projektet leds av Kalmar Kommun.
      </p>
    </div>
  </div>

  <script>
    // Peka på Unityns EGEN index.html (i din build-mapp)
    const UNITY_URL = "builds/sure-v1/index.html";

    // Din Google Apps Script Web App URL
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycby0pmWOdl8ARsFszjuh5DM8VgYRgBTJOzjSIYJLOwb3OuuxxMfgCpITmu2BD2dtZmUxXQ/exec";

    const stage = document.getElementById('stage');
    const pctEl = document.getElementById('pct');
    const wrap = document.getElementById('unityWrap');
    const frame = document.getElementById('unityFrame');
    frame.src = UNITY_URL;

    const TICK_MS = 60;
    const HOLD_CAP = 99;
    let target = 1, shown = 1, ready = false;

    // Lyssna på progress/ready från Unitys loader-sida
    window.addEventListener('message', (e) => {
      if (e.source !== frame.contentWindow || !e.data) return;
      if (e.data.type === 'unity-progress') {
        const p = Math.round(Math.max(0, Math.min(1, Number(e.data.value))) * 100);
        if (p > target) target = p;
      }
      if (e.data.type === 'unity-ready') { ready = true; target = 100; }
      if (e.data.type === 'unity-error') {
        pctEl.textContent = '—';
        console.error('Unity error:', e.data.message);
        clearInterval(ticker);
      }
    });

    const ticker = setInterval(() => {
      const cap = ready ? 100 : Math.min(HOLD_CAP, target);
      if (shown < cap) { shown += 1; pctEl.textContent = shown; }
      if (ready && shown >= 100) {
        setTimeout(() => {
          wrap.classList.add('show');
          wrap.setAttribute('aria-hidden', 'false');
          stage.classList.add('hide');
        }, 300);
        clearInterval(ticker);
      }
    }, TICK_MS);

    // Liten “självdrivande” progress om loadern ännu inte hunnit svara
    setTimeout(() => {
      if (target <= 1) {
        const creep = setInterval(() => {
          if (ready) return clearInterval(creep);
          target = Math.min(HOLD_CAP, target + 1);
          if (target >= 90) clearInterval(creep);
        }, 250);
      }
    }, 1200);

    // Fail-safe: om Unity aldrig postar 'ready' (t.ex. headers fel) – avbryt vänligt
    setTimeout(() => {
      if (!ready) {
        pctEl.textContent = '—';
        console.error('Unity laddar inte. Kontrollera att servern skickar Content-Encoding för .gz/.br.');
        clearInterval(ticker);
      }
    }, 15000);

    // Kommentar-UI
    const commentIcon = document.getElementById('comment-icon');
    const overlay = document.getElementById('overlay');
    const commentBox = document.querySelector('.comment-box');
    const submitBtn = document.getElementById('submit-comment');
    const commentInput = document.getElementById('comment-text');
    const statusEl = document.getElementById('status');

    commentIcon.addEventListener('click', function() {
      const toShow = overlay.style.display === 'none' || overlay.style.display === '' ? 'flex' : 'none';
      overlay.style.display = toShow;
      if (toShow === 'flex') {
        commentIcon.classList.remove('fa-comment'); commentIcon.classList.add('fa-xmark');
      } else {
        commentIcon.classList.remove('fa-xmark'); commentIcon.classList.add('fa-comment');
      }
    });
    overlay.addEventListener('click', function() {
      overlay.style.display = 'none';
      commentIcon.classList.remove('fa-xmark'); commentIcon.classList.add('fa-comment');
    });
    commentBox.addEventListener('click', function(event) { event.stopPropagation(); });

    async function submitComment() {
      const text = (commentInput.value || '').trim();
      statusEl.textContent = '';
      if (!text) {
        statusEl.textContent = 'Skriv något innan du skickar.';
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Skickar...';

      try {
        const res = await fetch(GAS_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }, // <-- viktigt!
          body: JSON.stringify({
            comment: text,
            page: location.href,
            userAgent: navigator.userAgent
          })
        });
        const data = await res.json().catch(() => ({}));

        if (res.ok && data.ok) {
          statusEl.textContent = 'Tack! Din kommentar är registrerad.';
          commentInput.value = '';
        } else {
          statusEl.textContent = 'Kunde inte spara just nu. Försök igen.';
          console.error('Save error:', data);
        }
      } catch (err) {
        statusEl.textContent = 'Nätverksfel. Kontrollera anslutningen.';
        console.error(err);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Skicka';
      }
    }

    submitBtn.addEventListener('click', submitComment);
    // Skicka även med Ctrl/Cmd+Enter
    commentInput.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') submitComment();
    });
  </script>
</body>
</html>
